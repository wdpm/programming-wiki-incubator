# redis 哨兵（理论篇）

哨兵的作用是监控Redis系统的运行状况。功能包括以下两个。

1. 监控主数据库和从数据库是否正常运行。
2. 主数据库出现故障时自动将从数据库转换为主数据库。

一主多从的Redis系统中，可以使用多个哨兵进行监控任务以保证系统足够稳健。不仅哨兵会同时监控主数据库和从数据库，哨兵之间也会互相监控。

**Redis 哨兵可以让主/从复制变得高可用**。

将哨兵配置为监视主实例和从属实例，如果主节点未按预期工作，它将执行自动故障转移。这意味着从属节点之一将被选举为主节点，而所有其他从属节点将被配置为使用新的主节点。

## 哨兵的监控策略

和主数据库的连接建立完成后，哨兵会定时执行下面3个操作。

1. 每10秒哨兵会向主数据库和从数据库发送INFO命令。
2. 每 2 秒哨兵会向主数据库和从数据库的`__sentinel__:hello`频道发送自己的信息。
3. 每1秒哨兵会向主数据库、从数据库和其他哨兵节点发送PING命令。

## 哨兵选举领头的Raft算法

1. 发现主数据库客观下线的哨兵节点 A 向每个哨兵节点发送命令，要求对方选自己成为领头哨兵。
2. 如果目标哨兵节点没有选过其他人，则会同意将A设置成领头哨兵。
3. 如果A发现有超过半数且超过quorum参数值的哨兵节点同意选自己成为领头哨兵，则A成功成为领头哨兵。
4. 当有多个哨兵节点同时参选领头哨兵，则会出现没有任何节点当选的可能。此时每个参选节点将等待一个随机时间重新发起参选请求，进行下一轮选举，直到选举成功。

> http://raftconsensus.github.io/

## 哨兵切换主从数据库

领头哨兵从停止服务的主数据库的从数据库中挑选一个来当新的主数据库。

1. 所有在线的从数据库中，选择优先级最高的从数据库。优先级可以通过slave-priority选项来设置。
2. 如果有多个最高优先级的从数据库，则复制的命令偏移量越大（即复制越完整）越优先。
3. 如果以上条件都一样，则选择运行ID较小的从数据库。

① 选出一个从数据库后，领头哨兵将向从数据库发送 SLAVEOF NO ONE命令使其升格为主数据库。

② 然后领头哨兵向其他从数据库发送SLAVEOF命令来使其成为新主数据库的从数据库。

③ 将已经停止服务的旧的主数据库更新为新的主数据库的从数据库，使得当其恢复服务时自动以从数据库的身份服务。

## 哨兵场景讨论

### 三个盒子的基本设置 

```
       +----+
       | M1 |
       | S1 |
       +----+
          |
+----+    |    +----+
| R2 |----+----| R3 |
| S2 |         | S3 |
+----+         +----+

Configuration: quorum = 2
```

当M1死掉后，假设R2成为新的主master，即[M2]。

```
         +----+
         | M1 |
         | S1 | <- C1 (writes will be lost)
         +----+
            |
            /
            /
+------+    |    +----+
| [M2] |----+----| R3 |
| S2   |         | S3 |
+------+         +----+
```

此时，M1不能正常处理C1客户端的请求，因此会丢失部分数据。想要减轻这个数据丢失，可以设置：

```bash
min-replicas-to-write 1
min-replicas-max-lag 10
```

`min-replicas-to-write 1`表示**当作为主服务器时，如果它不能写入至少一个副本，将停止接受写入**。

由于复制是异步的，因此**无法写入**意味着复制**副本已断开连接，或者没有向我们发送异步确认，已超过指定的最大延迟秒数**。 

### 客户端框有三个哨兵

```
            +----+         +----+
            | M1 |----+----| R1 |
            |    |    |    |    |
            +----+    |    +----+
                      |
         +------------+------------+
         |            |            |
         |            |            |
      +----+        +----+      +----+
      | C1 |        | C2 |      | C3 |
      | S1 |        | S2 |      | S3 |
      +----+        +----+      +----+

      Configuration: quorum = 2
```

此时，只有一个master和一个replica节点。

如果M1和S1所在的盒子故障，那么经过S2和S3的共识，R1将成为新master。

### 客户端框的哨兵少于三个

```
            +----+         +----+
            | M1 |----+----| R1 |
            | S1 |    |    | S2 |
            +----+    |    +----+
                      |
               +------+-----+
               |            |
               |            |
            +----+        +----+
            | C1 |        | C2 |
            | S3 |        | S4 |
            +----+        +----+

      Configuration: quorum = 3
```

四个可用的框中运行四个Sentinel，但是客户端只有两个哨兵，S3和S4。

如果主M1不可用，经过S2，S3，S4的共识，将执行故障转移。



